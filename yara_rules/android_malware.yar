/*
    YARA Rules for Android Malware Detection
    AndroSleuth Project
*/

rule Android_Trojan_Generic
{
    meta:
        description = "Generic Android Trojan Indicators"
        author = "AndroSleuth"
        severity = "high"
        category = "trojan"
    
    strings:
        $exec1 = "Runtime.getRuntime().exec" nocase
        $exec2 = "ProcessBuilder" nocase
        $root1 = "/system/xbin/su" nocase
        $root2 = "/system/bin/su" nocase
        $shell1 = "/system/bin/sh" nocase
        $shell2 = "chmod 777" nocase
        $hidden1 = "android.intent.action.BOOT_COMPLETED" nocase
        $hidden2 = "android.intent.action.USER_PRESENT" nocase
        $sms1 = "android.provider.Telephony.SMS_RECEIVED" nocase
        $sms2 = "SmsManager" nocase
    
    condition:
        (($exec1 or $exec2) and ($root1 or $root2)) or
        (($shell1 or $shell2) and ($hidden1 or $hidden2)) or
        ($sms1 and $sms2)
}

rule Android_Spyware_SMS_Stealer
{
    meta:
        description = "Android SMS Stealing Spyware"
        author = "AndroSleuth"
        severity = "critical"
        category = "spyware"
    
    strings:
        $sms1 = "content://sms" nocase
        $sms2 = "content://sms/inbox" nocase
        $sms3 = "content://sms/sent" nocase
        $network1 = "HttpURLConnection" nocase
        $network2 = "HttpClient" nocase
        $network3 = "okhttp" nocase
        $perm1 = "READ_SMS" nocase
        $perm2 = "RECEIVE_SMS" nocase
        $encode1 = "Base64.encode" nocase
        $encode2 = "URLEncoder" nocase
    
    condition:
        2 of ($sms*) and 1 of ($network*) and 1 of ($perm*) and 1 of ($encode*)
}

rule Android_Spyware_Location_Tracker
{
    meta:
        description = "Android Location Tracking Spyware"
        author = "AndroSleuth"
        severity = "high"
        category = "spyware"
    
    strings:
        $loc1 = "LocationManager" nocase
        $loc2 = "getLastKnownLocation" nocase
        $loc3 = "requestLocationUpdates" nocase
        $net1 = "HttpPost" nocase
        $net2 = "URLConnection" nocase
        $perm1 = "ACCESS_FINE_LOCATION" nocase
        $perm2 = "ACCESS_COARSE_LOCATION" nocase
        $bg1 = "START_STICKY" nocase
        $bg2 = "startService" nocase
    
    condition:
        2 of ($loc*) and 1 of ($net*) and 1 of ($perm*) and 1 of ($bg*)
}

rule Android_Ransomware_Screen_Locker
{
    meta:
        description = "Android Screen Locking Ransomware"
        author = "AndroSleuth"
        severity = "critical"
        category = "ransomware"
    
    strings:
        $lock1 = "TYPE_SYSTEM_ALERT" nocase
        $lock2 = "TYPE_SYSTEM_OVERLAY" nocase
        $lock3 = "FLAG_NOT_TOUCHABLE" nocase
        $lock4 = "FLAG_NOT_FOCUSABLE" nocase
        $admin1 = "DeviceAdminReceiver" nocase
        $admin2 = "resetPassword" nocase
        $admin3 = "lockNow" nocase
        $ransom1 = "bitcoin" nocase
        $ransom2 = "payment" nocase
        $ransom3 = "unlock" nocase
        $crypt1 = "Cipher" nocase
        $crypt2 = "encrypt" nocase
    
    condition:
        2 of ($lock*) and 1 of ($admin*) and 1 of ($ransom*) or
        (2 of ($lock*) and 2 of ($crypt*))
}

rule Android_Banking_Trojan
{
    meta:
        description = "Android Banking Trojan"
        author = "AndroSleuth"
        severity = "critical"
        category = "trojan"
    
    strings:
        $overlay1 = "TYPE_APPLICATION_OVERLAY" nocase
        $overlay2 = "WindowManager.LayoutParams" nocase
        $access1 = "AccessibilityService" nocase
        $access2 = "onAccessibilityEvent" nocase
        $bank1 = "bank" nocase
        $bank2 = "card" nocase
        $bank3 = "account" nocase
        $sms1 = "abortBroadcast" nocase
        $sms2 = "SMS_RECEIVED" nocase
        $inject1 = "WebView" nocase
        $inject2 = "loadUrl" nocase
    
    condition:
        (1 of ($overlay*) and 1 of ($access*)) or
        (1 of ($bank*) and $sms1 and $sms2) or
        (1 of ($access*) and 1 of ($inject*))
}

rule Android_Adware_Aggressive
{
    meta:
        description = "Aggressive Adware Behavior"
        author = "AndroSleuth"
        severity = "medium"
        category = "adware"
    
    strings:
        $ad1 = "AdView" nocase
        $ad2 = "AdRequest" nocase
        $ad3 = "InterstitialAd" nocase
        $notif1 = "NotificationManager" nocase
        $notif2 = "NotificationCompat" nocase
        $boot = "BOOT_COMPLETED" nocase
        $alarm = "AlarmManager" nocase
        $click1 = "clickUrl" nocase
        $click2 = "performClick" nocase
    
    condition:
        2 of ($ad*) and 1 of ($notif*) and ($boot or $alarm) and 1 of ($click*)
}

rule Android_Backdoor_Remote_Control
{
    meta:
        description = "Remote Access Backdoor"
        author = "AndroSleuth"
        severity = "critical"
        category = "backdoor"
    
    strings:
        $socket1 = "ServerSocket" nocase
        $socket2 = "Socket" nocase
        $socket3 = "connect" nocase
        $cmd1 = "exec" nocase
        $cmd2 = "ProcessBuilder" nocase
        $cmd3 = "Runtime" nocase
        $root1 = "su -c" nocase
        $root2 = "/system/bin/su" nocase
        $net1 = "InetAddress" nocase
        $net2 = "InetSocketAddress" nocase
    
    condition:
        2 of ($socket*) and 1 of ($cmd*) and (1 of ($root*) or 1 of ($net*))
}

rule Android_Data_Exfiltration
{
    meta:
        description = "Data Exfiltration Indicators"
        author = "AndroSleuth"
        severity = "high"
        category = "exfiltration"
    
    strings:
        $contact1 = "content://com.android.contacts" nocase
        $contact2 = "ContactsContract" nocase
        $call1 = "content://call_log/calls" nocase
        $sms1 = "content://sms" nocase
        $photo1 = "DCIM" nocase
        $photo2 = "MediaStore" nocase
        $net1 = "HttpPost" nocase
        $net2 = "MultipartEntity" nocase
        $net3 = "FileEntity" nocase
        $upload1 = "upload" nocase
        $upload2 = "send" nocase
    
    condition:
        (1 of ($contact*) or $call1 or $sms1 or 1 of ($photo*)) and
        1 of ($net*) and 1 of ($upload*)
}

rule Android_Keylogger
{
    meta:
        description = "Keylogger Behavior"
        author = "AndroSleuth"
        severity = "critical"
        category = "spyware"
    
    strings:
        $access1 = "AccessibilityService" nocase
        $access2 = "TYPE_VIEW_TEXT_CHANGED" nocase
        $access3 = "onAccessibilityEvent" nocase
        $input1 = "InputMethodService" nocase
        $input2 = "onKeyDown" nocase
        $input3 = "onTextChanged" nocase
        $log1 = "StringBuilder" nocase
        $log2 = "append" nocase
        $net1 = "HttpURLConnection" nocase
        $file1 = "FileOutputStream" nocase
    
    condition:
        (2 of ($access*) or 2 of ($input*)) and 
        ($log1 and $log2) and ($net1 or $file1)
}

rule Android_Premium_SMS_Fraud
{
    meta:
        description = "Premium SMS Fraud"
        author = "AndroSleuth"
        severity = "high"
        category = "fraud"
    
    strings:
        $sms1 = "SmsManager" nocase
        $sms2 = "sendTextMessage" nocase
        $sms3 = "sendMultipartTextMessage" nocase
        $premium1 = /\d{4,5}/ // Short codes
        $hide1 = "abortBroadcast" nocase
        $hide2 = "SMS_SENT" nocase
        $perm1 = "SEND_SMS" nocase
        $perm2 = "RECEIVE_SMS" nocase
    
    condition:
        2 of ($sms*) and $premium1 and 1 of ($hide*) and 1 of ($perm*)
}

rule Android_Privilege_Escalation
{
    meta:
        description = "Privilege Escalation Attempts"
        author = "AndroSleuth"
        severity = "critical"
        category = "exploit"
    
    strings:
        $exploit1 = "CVE-" nocase
        $exploit2 = "exploit" nocase
        $root1 = "su -c" nocase
        $root2 = "/system/xbin/su" nocase
        $root3 = "Superuser" nocase
        $mount1 = "mount -o remount" nocase
        $mount2 = "/system" nocase
        $shell1 = "chmod 777" nocase
        $shell2 = "chmod +x" nocase
        $native1 = "System.loadLibrary" nocase
        $native2 = ".so" nocase
    
    condition:
        (1 of ($exploit*) and 1 of ($root*)) or
        (1 of ($mount*) and 1 of ($shell*)) or
        (2 of ($root*) and 1 of ($native*))
}

rule Android_Cryptocurrency_Miner
{
    meta:
        description = "Cryptocurrency Mining Malware"
        author = "AndroSleuth"
        severity = "high"
        category = "miner"
    
    strings:
        $coin1 = "monero" nocase
        $coin2 = "bitcoin" nocase
        $coin3 = "mining" nocase
        $coin4 = "cryptonight" nocase
        $pool1 = "stratum" nocase
        $pool2 = "pool" nocase
        $cpu1 = "Runtime.getRuntime().availableProcessors" nocase
        $cpu2 = "ActivityManager" nocase
        $native1 = "System.loadLibrary" nocase
        $native2 = "libminer" nocase
    
    condition:
        2 of ($coin*) and 1 of ($pool*) and (1 of ($cpu*) or 1 of ($native*))
}

rule Android_Fake_Installer
{
    meta:
        description = "Fake Application Installer"
        author = "AndroSleuth"
        severity = "high"
        category = "trojan"
    
    strings:
        $install1 = "android.intent.action.PACKAGE_INSTALL" nocase
        $install2 = "PackageInstaller" nocase
        $install3 = "installPackage" nocase
        $download1 = "DownloadManager" nocase
        $download2 = "enqueue" nocase
        $perm1 = "REQUEST_INSTALL_PACKAGES" nocase
        $perm2 = "INSTALL_PACKAGES" nocase
    
    condition:
        2 of ($install*) and 1 of ($download*) and 1 of ($perm*)
}
